{% extends "my_page.html" %}
{% import 'macros/form.html' as form %}

{% block subtitle %}{{ _("Data Quality") }}{% endblock %}

{% block styles %}
{{ super() }}
{% asset "opendquality/opendquality-css" %}
{% endblock %}

{% block breadcrumb_content %}
<li class="active">{{ _('Data Quality') }}</li>
{% endblock %}

{% block secondary_content %}
{% include "ckanext/opendquality/left_side.html" %}
{% endblock %}

{% block page_header %}
{% endblock %}
{% block primary_content_inner %}
<h1>{{ title }}</h1>
<div class="row table-responsive">
  <form id='org-filter-form' class="form-inline" method="GET" action="{{ h.url_for('opendquality.dashboard') }}">
    {{ h.csrf_input() }}
    {%- set options=[] -%}
    {%- do options.append({'value': '', 'text': _('-- เลือกหน่วยงานหลัก --')}) -%}
    {%- for p in parents -%}
    {%- do options.append({'value': p.id|string, 'text': p.title}) -%}
    {%- endfor -%}
    {{ form.select(
    'org_main',
    label=_('หน่วยงานหลัก'),
    selected=selected_main,
    options=options,
    classes=[],
    id='org_main',
    attrs={'data-module': 'autocomplete'},
    error={}
    )}}

    {%- set options=[] -%}
    {%- do options.append({'value': '', 'text': _('-- เลือกหน่วยงานย่อย --')}) -%}
    {% if sub_options %}
    {%- for c in sub_options -%}
    {%- do options.append({'value': c.id|string, 'text': c.title}) -%}
    {%- endfor -%}
    {% endif %}
    {{ form.select(
    'org_sub',
    label=_('หน่วยงานย่อย'),
    selected=selected_sub,
    options=options,
    classes=[],
    id='org_sub',
    attrs={'data-module': 'autocomplete'},
    error={}
    )}}
    <button type="submit" class="btn btn-primary">{{ _('แสดงรายงาน') }}</button>
  </form>
</div>
<hr>
<!-- <div class="row">
  <div class="primary col-md-6 col-xs-12">
    <canvas id="radar_chart"></canvas>
  </div>
  <div class="primary col-md-3 col-xs-12">
    <div class="col-md-12">$$$#####</div>
    <div class="col-md-12">444@@@@@</div>
    <div class="col-md-12">erRRREERRE</div>
  </div>
</div> -->
<div class="row qa-radar-row" style="z-index: 2;">
  <div class="primary col-md-6 col-xs-12">
    <canvas id="radar_chart" data-module="opendquality-radar-chart"></canvas>
  </div>

  <div class="primary col-md-3 col-xs-12">
    <div class="panel panel-default qa-stats">
      <div class="panel-heading">สรุปภาพรวม</div>
      <div class="panel-body">
        <div class="qa-stats-list">
          <div class="qa-stat qa-stat--org">
            <span class="qa-stat-label">หน่วยงาน</span>
            <span class="qa-stat-value">{{ counts.organizations }}</span>
          </div>
          <div class="qa-stat qa-stat--ds">
            <span class="qa-stat-label">ชุดข้อมูล</span>
            <span class="qa-stat-value">{{ counts.datasets }}</span>
          </div>
          <div class="qa-stat qa-stat--res">
            <span class="qa-stat-label">Resource</span>
            <span class="qa-stat-value">{{ counts.resources }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card mt-3" style="z-index: 2;">
  <div class="card-header text-center">
    <div class="h5 mb-0">มิติด้าน</div>
    <div class="h4 fw-bold">Timeliness</div>
  </div>
  <div class="card-body">
    <div class="row g-3 align-items-stretch">

      <!-- Freshness panel -->
      <div class="col-lg-4">
        <div class="border rounded h-100 p-3 position-relative">
          <div class="fw-bold mb-2">Freshness</div>
          <div class="position-absolute top-0 end-0 m-2 badge bg-warning text-dark"
               id="badge-freshness">Dataset AVG Freshness: –</div>
          <canvas id="chart-freshness" style="height:120px; width:100%;"></canvas>
          <div class="text-center mt-2 text-muted">ความสดใหม่ของข้อมูล</div>
        </div>
      </div>

      <!-- Acceptable Latency + Outdated -->
      <div class="col-lg-8">
        <div class="border rounded h-100 p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold">Acceptable Latency</div>
            <span class="badge bg-warning text-dark" id="badge-latmax">
              Dataset Acceptable Latency MAX: –
            </span>
          </div>
          <div class="row g-3">
            <div class="col-8">
              <canvas id="chart-latency" style="height:220px; width:100%;"></canvas>
              <div class="small text-muted mt-1">ชุดข้อมูลที่ควรปรับปรุง</div>
            </div>
            <div class="col-4 border-start">
              <canvas id="chart-outdated" style="height:220px; width:100%;"></canvas>
              <div class="small text-center text-muted mt-1">ชุดข้อมูลล้าสมัยเกินไป</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="row row-cols-1 row-cols-lg-3 g-3 qa-metrics-row mt-3" style="z-index: 2;">
  <!-- 2) Relevancy -->
  <div class="col col-lg-8 d-flex">
    <div class="card flex-fill">
      <div class="card-header fw-semibold">ชุดข้อมูลที่ตรงตามความต้องการของผู้ใช้ (Relevancy)</div>
      <div class="card-body">
        <div class="row table-responsive" style="position: relative;">
          <table id="tb-relevance-result" class="table table-borderless table-striped">
            <thead>
              <tr>
                <th width="10%">{{ _("หน่วยงาน") }}</th>
                <th width="30%">{{ _("ชื่อชุดข้อมูล") }}</th>
                <th width="70%">{{ _(" ") }}</th>
              </tr>
            </thead>
            <tbody>
              {% for rev in top_relevance %}
                <tr>
                  <td><a href="{{ h.url_for('opendquality.dashboard',org_id=rev.org.id, org_main=rev.org.parent_id, org_sub=rev.org.id) }}">
                    {{ rev.org.title }}</a></td>
                  <td><a href="{{ h.url_for('opendquality.admin_report',org_id=rev.org.id, package_id=rev.id, org_main=rev.org.parent_id, org_sub=rev.org.id) }}"
            target="qa-link">{{ rev.title }}</a></td>
                  <td>
                    <div class="progress">
                      <div class="progress-bar bg-info" role="progressbar" style="width: {{_(rev.relevance)}}%;" aria-valuenow="{{_(rev.relevance)}}" aria-valuemin="0" aria-valuemax="100">{{_(rev.relevance)}}%</div>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 3) Availability -->
  <div class="col col-lg-4 d-flex">
    <div class="card flex-fill">
      <div class="card-header fw-semibold">มิติด้าน Availability</div>
      <div class="card-body">
        <div class="d-flex align-items-center gap-4 mb-3 qa-donut">
          <div class="fw-semibold text-muted" style="width:10rem;">Downloadable</div>
          <div class="qa-donut-wrap">
            <canvas id="chart-dl"></canvas>
            <div class="qa-donut-center" id="center-dl"></div>
          </div>
        </div>
        <div class="d-flex align-items-center gap-4 qa-donut">
          <div class="fw-semibold text-muted" style="width:10rem;">Access API</div>
          <div class="qa-donut-wrap">
            <canvas id="chart-api"></canvas>
            <div class="qa-donut-center" id="center-api"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>


{% endblock %}


{% block scripts %}
{{ super() }}
{% asset "opendquality/opendquality-js" %}
<script>
  window.CHILDREN_BY_PARENT = {{ children_by_parent | tojson | safe }};
  window.SUB_DEFAULT_LABEL  = {{ _('-- เลือกหน่วยงานย่อย --') | tojson }};
  window.SUB_SELECTED       = "{{ selected_sub }}";
</script>
<script>
  // document.getElementById('org-filter-form').addEventListener('submit', function (e) {
  //   e.preventDefault();
  //   const selected = document.getElementById('org-select').value;
  //   const newUrl = selected ? `/qa/dashboard/${selected}` : '/qa/dashboard';
  //   window.location.href = newUrl;
  // });
  const radar_chart_config = {
    labels: {{ radar_data.labels | tojson }},
    datasets: [
      {
        label: '{{ _("คะแนนคุณภาพชุดข้อมูล") }}',
        data: {{ radar_data.data | tojson }},
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        borderColor: 'rgba(255, 99, 132, 1)',
        borderWidth: 1
        }
    ]
  }

  var M = {{ metrics| tojson | safe}};
  var T = {{ timeliness_summary | tojson | safe}};

  // สร้างกราฟสำหรับแต่ละมิติ
//   document.addEventListener('DOMContentLoaded', function () {
//     const M = {{ metrics| tojson | safe}};
//   // Validity – bar
//   // new Chart(document.getElementById('chart-validity'), {
//   //   type: 'bar',
//   //   data: {
//   //     labels: ['blank header', 'duplicate header', 'extra value'],
//   //     datasets: [{ data: [M.validity.blank_header, M.validity.duplicate_header, M.validity.extra_value] }]
//   //   },
//   //   options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
//   // });

//   // // Relevancy – horizontal bar
//   // new Chart(document.getElementById('chart-relevancy'), {
//   //   type: 'bar',
//   //   data: {
//   //     labels: ['จำนวนการดาวน์โหลด (Download)', 'จำนวนการเข้าชม (View)'],
//   //     datasets: [{ data: [M.relevancy.downloads, M.relevancy.views] }]
//   //   },
//   //   options: {
//   //     indexAxis: 'y', responsive: true, plugins: { legend: { display: false } },
//   //     scales: { x: { beginAtZero: true, ticks: { precision: 0 } } }
//   //   }
//   // });

//   // // Availability – donuts
//   // donut('chart-dl', 'center-dl', M.availability.downloadable.yes, M.availability.downloadable.no);
//   // donut('chart-api', 'center-api', M.availability.access_api.yes, M.availability.access_api.no);
// });
</script>
{%endblock %}