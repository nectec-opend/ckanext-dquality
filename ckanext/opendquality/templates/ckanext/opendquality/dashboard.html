{% extends "my_page.html" %}
{% import 'macros/form.html' as form %}

{% block subtitle %}{{ _("Data Quality") }}{% endblock %}

{% block styles %}
{{ super() }}
{% asset "opendquality/opendquality-css" %}
{% endblock %}

{% block breadcrumb_content %}
<li class="active">{{ _('Data Quality') }}</li>
{% endblock %}

{% block secondary_content %}
{% include "ckanext/opendquality/left_side.html" %}
{% endblock %}

{% block page_header %}
{% endblock %}
{% block primary_content_inner %}
<h1>{{ title }}</h1>
<div class="row table-responsive">
  <form id='org-filter-form' class="form-inline" method="GET" action="{{ h.url_for('opendquality.dashboard') }}">
    {% include "ckanext/opendquality/qa_filter_form.html" %}
    <button type="submit" class="btn btn-primary">{{ _('‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô') }}</button>
  </form>
</div>
<hr>
<div class="row" style="z-index: 2;">
  <div class="panel panel-default qa-stats">
    <div class="panel-body">
      <div class="qa-stats-list">
        <div class="qa-stat qa-stat--org">
          <span class="qa-stat-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</span>
          <span class="qa-stat-value">{{ counts.organizations }}</span>
        </div>
        <div class="qa-stat qa-stat--ds">
          <span class="qa-stat-label">‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
          <span class="qa-stat-value">{{ counts.datasets }}</span>
        </div>
        <div class="qa-stat qa-stat--res">
          <span class="qa-stat-label">‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£</span>
          <span class="qa-stat-value">{{ counts.resources }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row qa-radar-row" style="z-index: 2;">
  <div class="col col-lg-8">
    <div>
      
      <h3 class="section-title mb-3">
        <span class="me-2">üß©</span> ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£)
      </h3>
      <div class="row g-3 mb-4">
        <div class="col-12 col-md-6">
          <div class="metric-tile">
            <div class="metric-label">Structured Data</div>
            <div class="metric-value value-green">{{ openness_count.structured}}</div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="metric-tile">
            <div class="metric-label">Unstructured Data</div>
            <div class="metric-value value-red">{{ openness_count.unstructured}}</div>
          </div>
        </div>
      </div>

      <h3 class="section-title mb-3">
        <span class="me-2">ü§ñ</span> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£)
      </h3>
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <div class="metric-tile">
            <div class="metric-label">Machine-Readable</div>
            <div class="metric-value value-green">{{ validity_count.validity }}</div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="metric-tile">
            <div class="metric-label">Not Machine-Readable</div>
            <div class="metric-value value-red">{{ validity_count.un_validity }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="primary col-md-4 col-xs-12">
    <div class="panel panel-default">
      <h3 class="section-title mb-3">‡∏°‡∏¥‡∏ï‡∏¥‡∏î‡πâ‡∏≤‡∏ô Openness (‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</h3>
      <div class="panel-body">
        <div class="openness-card">
          <table class="table table-borderless table-striped openness-table mb-0">
            <tbody>
              <tr>
                <td class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</td>
                <td class="text-center">{{ openness_score.get('5 Star', 0) }}</td>
              </tr>
              <tr>
                <td class="stars">‚òÖ‚òÖ‚òÖ‚òÖ</td>
                <td class="text-center">{{ openness_score.get('4 Star', 0) }}</td>
              </tr>
              <tr>
                <td class="stars">‚òÖ‚òÖ‚òÖ</td>
                <td class="text-center">{{ openness_score.get('3 Star', 0) }}</td>
              </tr>
              <tr>
                <td class="stars">‚òÖ‚òÖ</td>
                <td class="text-center">{{ openness_score.get('2 Star', 0) }}</td>
              </tr>
              <tr>
                <td class="stars">‚òÖ</td>
                <td class="text-center">{{ openness_score.get('1 Star', 0) }}</td>
              </tr>
              <tr>
                <td class="h4 fw-bold">Other</td>
                <td class="text-center">{{ openness_score.Other }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row row-cols-1 row-cols-lg-3 g-3 qa-metrics-row mt-3" style="z-index: 2;">
  <div class="col col-lg-6 col-xs-12">
    <canvas id="radar_chart" data-module="opendquality-radar-chart"></canvas>
  </div>
  
  <div class="col col-lg-6">
    <div class="card">
      <div class="card-header fw-semibold bg-light">
        <h4 class="mb-0">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£)</h4>
      </div>
      <div class="card-body" style="height:260px">
        <canvas id="dqmFormatBar"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="card mt-3" style="z-index: 2;">
  <div class="card-header text-center">
    <div class="h5 mb-0">‡∏°‡∏¥‡∏ï‡∏¥‡∏î‡πâ‡∏≤‡∏ô</div>
    <div class="h4 fw-bold">Timeliness (‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</div>
  </div>
  <div class="card-body">
    <div class="row g-3 align-items-stretch">

      <!-- Freshness panel -->
      <div class="col-lg-4">
        <div class="border rounded h-100 p-3 position-relative">
          <div class="fw-bold mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</div>
          <canvas id="chart-freshness" style="height:120px; width:100%;"></canvas>
          <!-- <div class="text-center mt-2 text-muted">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏î‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div> -->
        </div>
      </div>

      <!-- Acceptable Latency + Outdated -->
      <div class="col-lg-8">
        <div class="border rounded h-100 p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</div>
          </div>
          <div class="row g-3">
            <div class="col-8">
              <canvas id="chart-latency" style="height:220px; width:100%;"></canvas>
              <div class="small text-muted mt-1">‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</div>
            </div>
            <div class="col-4 border-start">
              <canvas id="chart-outdated" style="height:220px; width:100%;"></canvas>
              <div class="small text-center text-muted mt-1">‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏≤‡∏™‡∏°‡∏±‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="row row-cols-1 row-cols-lg-3 g-3 qa-metrics-row mt-3" style="z-index: 2;">
  <!-- 2) Relevancy -->
  <div class="col col-lg-8 d-flex">
    <div class="card flex-fill">
      <div class="card-header fw-semibold">5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Relevancy) (‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</div>
      <div class="card-body">
        <div class="row table-responsive" style="position: relative;">
          <table id="tb-relevance-result" class="table table-borderless table-striped">
            <thead>
              <tr>
                <th width="10%">{{ _("‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô") }}</th>
                <th width="30%">{{ _("‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•") }}</th>
                <th width="70%">{{ _(" ") }}</th>
              </tr>
            </thead>
            <tbody>
              {% for rev in top_relevance %}
              <tr>
                <td><a
                    href="{{ h.url_for('opendquality.dashboard',org_id=rev.org.id, org_main=rev.org.parent_id, org_sub=rev.org.id, ver_selected=selected_version) }}">
                    {{ rev.org.title }}</a></td>
                <td><a
                    href="{{ h.url_for('opendquality.admin_report',org_id=rev.org.id, package_id=rev.id, org_main=rev.org.parent_id, org_sub=rev.org.id, ver_selected=selected_version) }}"
                    target="qa-link">{{ rev.title }}</a></td>
                <td>
                  <div class="progress">
                    <div class="progress-bar bg-info" role="progressbar" style="width: {{_(rev.relevance)}}%;"
                      aria-valuenow="{{_(rev.relevance)}}" aria-valuemin="0" aria-valuemax="100">{{_(rev.relevance)}}%
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 3) Availability -->
  <div class="col col-lg-4 d-flex">
    <div class="card flex-fill">
      <div class="card-header fw-semibold">‡∏°‡∏¥‡∏ï‡∏¥‡∏î‡πâ‡∏≤‡∏ô Availability (‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£)</div>
      <div class="card-body">
        <div class="d-flex align-items-center gap-4 mb-3 qa-donut">
          <div class="fw-semibold text-muted" style="width:10rem;">Downloadable</div>
          <div class="qa-donut-wrap">
            <canvas id="chart-dl"></canvas>
            <div class="qa-donut-center" id="center-dl"></div>
          </div>
        </div>
        <div class="d-flex align-items-center gap-4 qa-donut">
          <div class="fw-semibold text-muted" style="width:10rem;">Access API</div>
          <div class="qa-donut-wrap">
            <canvas id="chart-api"></canvas>
            <div class="qa-donut-center" id="center-api"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

{% endblock %}


{% block scripts %}
{{ super() }}
{% asset "opendquality/opendquality-js" %}
<script>
  {% if parents is not none %}
  window.CHILDREN_BY_PARENT = {{ children_by_parent | tojson | safe }};
  {% endif %}
  window.SUB_DEFAULT_LABEL = {{ _('-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --') | tojson }};
  window.SUB_SELECTED = "{{ selected_sub }}";
</script>
<script>
  const radar_chart_config = {
    labels: {{ radar_data.labels | tojson }},
  datasets: [
    {
      label: '{{ _("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•") }}',
      data: {{ radar_data.data | tojson }},
    backgroundColor: 'rgba(255, 99, 132, 0.2)',
    borderColor: 'rgba(255, 99, 132, 1)',
    borderWidth: 1
        }
  ]
  }

  var M = {{ metrics| tojson | safe}};
  var T = {{ timeliness_summary | tojson | safe}};
  const { labels, data } = {{ resource_format_count | tojson | safe }};
  const versions = {{ versions | tojson | safe }};
  var selected_version = "{{ selected_version }}";
</script>
{%endblock %}